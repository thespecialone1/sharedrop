#!/bin/bash

DIR="$(cd "$(dirname "$0")/../Resources" && pwd)"
cd "$DIR"

# Kill any existing instances
pkill -f "file-share-app" 2>/dev/null
pkill -f "cloudflared.*8080" 2>/dev/null

# Start server
./file-share-app > /tmp/sharedrop.log 2>&1 &

sleep 2

# Start cloudflare tunnel if available
if command -v cloudflared &> /dev/null; then
    cloudflared tunnel --url http://localhost:8080 > /tmp/sharedrop-tunnel.log 2>&1 &
    sleep 3
    TUNNEL_URL=$(grep -o 'https://[a-z0-9-]*\.trycloudflare\.com' /tmp/sharedrop-tunnel.log 2>/dev/null | head -n 1)
    
    if [ ! -z "$TUNNEL_URL" ]; then
        # Save tunnel URL for the web app to read
        echo "$TUNNEL_URL" > /tmp/sharedrop-tunnel-url.txt
        osascript -e "display notification \"Internet: $TUNNEL_URL\" with title \"ShareDrop Started\""
    else
        osascript -e 'display notification "Local: http://localhost:8080" with title "ShareDrop Started"'
    fi
else
    osascript -e 'display notification "Install cloudflared for internet sharing" with title "ShareDrop Started"'
fi

# Open browser
open "http://localhost:8080"
